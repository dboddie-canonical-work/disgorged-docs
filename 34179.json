{"post_stream":{"posts":[{"id":120611,"name":"David Boddie","username":"dboddie","avatar_template":"/user_avatar/forum.snapcraft.io/dboddie/{size}/9564_2.png","created_at":"2023-03-03T16:07:41.560Z","cooked":"\u003cp\u003eSome snaps need to have access to system resources outside the scope allowed by strict confinement, and they are unable to do this via the available interfaces. These snaps are configured to use classic confinement and will \u003ca href=\"/t/process-for-reviewing-classic-confinement-snaps/1460\"\u003eneed to be reviewed\u003c/a\u003e before publication in the Snap Store.\u003c/p\u003e\n\u003cp\u003eThis guide shows how to enable classic confinement for a snap built with the \u003ca href=\"/t/the-python-plugin\"\u003epython plugin\u003c/a\u003e. The example project used in this guide can be found in the \u003ca href=\"https://github.com/snapcraft-docs/python-ctypes-example\"\u003eexample repository\u003c/a\u003e.\u003c/p\u003e\n\u003ch2\u003eChange the confinement to classic\u003c/h2\u003e\n\u003cp\u003eStarting with an existing snapcraft.yaml file, change the \u003ccode\u003econfinement\u003c/code\u003e setting to \u003ccode\u003eclassic\u003c/code\u003e:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"lang-yaml\"\u003econfinement: classic\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis will cause the snap to be built in a way that gives it access to system resources.\u003c/p\u003e\n\u003ch2\u003ePatch ctypes to load system libraries\u003c/h2\u003e\n\u003cp\u003eIf your application uses \u003ca href=\"https://docs.python.org/3/library/ctypes.html\"\u003ectypes\u003c/a\u003e to access system libraries it will need to be bundled with a patched version of the module. To bundle \u003ccode\u003ectypes\u003c/code\u003e, include the relevant packages in the \u003ccode\u003estage-packages\u003c/code\u003e list of packages. For the \u003ca href=\"/t/base-snaps\"\u003ecore22 base\u003c/a\u003e, the packages will be the following:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"lang-yaml\"\u003e    stage-packages:\n      - libpython3.10-minimal\n      - libpython3.10-stdlib\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003ePatching is done by overriding the build step to perform the build as normal, by running \u003ccode\u003esnapcraftctl build\u003c/code\u003e, then applying \u003ca href=\"https://github.com/snapcraft-docs/python-ctypes-example/blob/main/snap/local/patches/ctypes_init.diff\"\u003ea patch\u003c/a\u003e to the staged module file with a script:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"lang-yaml\"\u003e    override-build: |\n      snapcraftctl build\n      $SNAPCRAFT_PROJECT_DIR/snap/local/patch-ctypes.sh\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eAn \u003ca href=\"https://github.com/snapcraft-docs/python-ctypes-example/tree/main/snap/local\"\u003eexample script and patch\u003c/a\u003e can be found in the \u003ca href=\"https://github.com/snapcraft-docs/python-ctypes-example\"\u003eexample repository\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eRun Snapcraft to build the snap with these changes. This may produce warnings about run-time library paths like the following:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003eLint warnings:\n- classic: usr/lib/python3.10/lib-dynload/_asyncio.cpython-310-x86_64-linux-gnu.so: ELF rpath should be set to '/snap/core22/current/lib/x86_64-linux-gnu'. (https://snapcraft.io/docs/linters-classic)\n- classic: usr/lib/python3.10/lib-dynload/_bz2.cpython-310-x86_64-linux-gnu.so: ELF rpath should be set to '/snap/core22/current/lib/x86_64-linux-gnu'. (https://snapcraft.io/docs/linters-classic)\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThese warnings tell us that the run-time library paths of some core Python modules need to be patched to refer to libraries in the base snap.\u003c/p\u003e\n\u003ch2\u003eFix linter warnings by patching ELF binaries\u003c/h2\u003e\n\u003cp\u003eThe easiest way to handle warnings about the ELF interpreter and rpath is to let Snapcraft automatically patch the binaries using \u003ccode\u003epatchelf\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eThis is enabled by default for \u003ccode\u003ecore20\u003c/code\u003e classic snaps, and can also be enabled for \u003ccode\u003ecore22\u003c/code\u003e classic snaps if you are using Snapcraft 7.3 or a version from the edge channel. Pass the \u003ccode\u003eenable-patchelf\u003c/code\u003e build attribute to the plugin:\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"lang-yaml\"\u003e    build-attributes:\n     - enable-patchelf\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eThis can be removed when automatic patching is enabled for \u003ccode\u003ecore22\u003c/code\u003e classic snaps in stable releases.\u003c/p\u003e\n\u003ch2\u003eRebuild the snap\u003c/h2\u003e\n\u003cp\u003eRun Snapcraft again to rebuild the snap, consulting the \u003ca href=\"/t/32228\"\u003eClassic linter\u003c/a\u003e documentation to resolve further issues.\u003c/p\u003e\n\u003cp\u003eSee also \u003ca href=\"https://snapcraft.io/blog/the-new-classic-confinement-in-snaps-even-the-classics-need-a-change\"\u003ethis article\u003c/a\u003e for an overview of the classic linter and a discussion of the issues involved in building snaps for classic confinement.\u003c/p\u003e","post_number":1,"post_type":1,"updated_at":"2023-06-13T14:13:20.712Z","reply_count":0,"reply_to_post_number":null,"quote_count":0,"incoming_link_count":65,"reads":13,"readers_count":12,"score":332.6,"yours":false,"topic_id":34179,"topic_slug":"set-up-classic-confinement-for-a-python-project","display_username":"David Boddie","primary_group_name":null,"primary_group_flair_url":null,"primary_group_flair_bg_color":null,"primary_group_flair_color":null,"version":9,"can_edit":false,"can_delete":false,"can_recover":false,"can_wiki":false,"link_counts":[{"url":"https://snapcraft.io/blog/the-new-classic-confinement-in-snaps-even-the-classics-need-a-change","internal":false,"reflection":false,"title":"The new classic confinement in snaps – Even the classics need a change | Snapcraft","clicks":1},{"url":"https://forum.snapcraft.io/t/the-python-plugin/8529","internal":true,"reflection":false,"title":"The python plugin","clicks":0},{"url":"https://docs.python.org/3/library/ctypes.html","internal":false,"reflection":false,"clicks":0},{"url":"https://github.com/snapcraft-docs/python-ctypes-example","internal":false,"reflection":false,"clicks":0},{"url":"https://forum.snapcraft.io/t/process-for-reviewing-classic-confinement-snaps/1460","internal":true,"reflection":false,"title":"Process for reviewing classic confinement snaps","clicks":0},{"url":"https://forum.snapcraft.io/t/classic-linter/32228","internal":true,"reflection":false,"title":"Classic linter","clicks":0},{"url":"https://github.com/snapcraft-docs/python-ctypes-example/tree/main/snap/local","internal":false,"reflection":false,"title":"python-ctypes-example/snap/local at main · snapcraft-docs/python-ctypes-example · GitHub","clicks":0},{"url":"https://github.com/snapcraft-docs/python-ctypes-example/blob/main/snap/local/patches/ctypes_init.diff","internal":false,"reflection":false,"clicks":0},{"url":"https://forum.snapcraft.io/t/base-snaps/11198","internal":true,"reflection":false,"title":"Base snaps","clicks":0},{"url":"https://forum.snapcraft.io/t/how-to-guides-for-classic-confinement/34416","internal":true,"reflection":true,"title":"How to guides for classic confinement","clicks":0},{"url":"https://forum.snapcraft.io/t/snap-documentation/11127","internal":true,"reflection":true,"title":"Snap documentation","clicks":0}],"read":true,"user_title":null,"bookmarked":false,"actions_summary":[{"id":2,"count":1}],"moderator":false,"admin":true,"staff":true,"user_id":14015,"hidden":false,"trust_level":4,"deleted_at":null,"user_deleted":false,"edit_reason":null,"can_view_edit_history":true,"wiki":true,"last_wiki_edit":"2023-06-13T14:13:20.734Z","can_accept_answer":false,"can_unaccept_answer":false,"accepted_answer":false}],"stream":[120611]},"timeline_lookup":[[1,104]],"suggested_topics":[{"id":30990,"title":"The steam-support interface","fancy_title":"The steam-support interface","slug":"the-steam-support-interface","posts_count":2,"reply_count":0,"highest_post_number":2,"image_url":null,"created_at":"2022-07-22T12:51:00.480Z","last_posted_at":"2022-07-27T09:14:33.468Z","bumped":true,"bumped_at":"2022-07-27T09:14:33.468Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags":[],"like_count":2,"views":1026,"category_id":15,"featured_link":null,"has_accepted_answer":false,"posters":[{"extras":"latest single","description":"Original Poster, Most Recent Poster","user":{"id":2772,"username":"degville","name":"Graham Morrison","avatar_template":"/user_avatar/forum.snapcraft.io/degville/{size}/2021_2.png"}}]},{"id":32228,"title":"Classic linter","fancy_title":"Classic linter","slug":"classic-linter","posts_count":3,"reply_count":1,"highest_post_number":3,"image_url":null,"created_at":"2022-10-18T17:22:41.599Z","last_posted_at":"2022-10-19T13:02:49.311Z","bumped":true,"bumped_at":"2022-10-19T13:02:49.311Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags":[],"like_count":2,"views":921,"category_id":15,"featured_link":null,"has_accepted_answer":false,"posters":[{"extras":"latest","description":"Original Poster, Most Recent Poster","user":{"id":3793,"username":"cmatsuoka","name":"Claudio Matsuoka","avatar_template":"/user_avatar/forum.snapcraft.io/cmatsuoka/{size}/9338_2.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":393,"username":"jamesh","name":"James Henstridge","avatar_template":"/user_avatar/forum.snapcraft.io/jamesh/{size}/3947_2.png"}}]},{"id":30982,"title":"The acrn interface","fancy_title":"The acrn interface","slug":"the-acrn-interface","posts_count":3,"reply_count":1,"highest_post_number":3,"image_url":null,"created_at":"2022-07-21T14:25:57.164Z","last_posted_at":"2022-08-05T17:30:59.540Z","bumped":true,"bumped_at":"2022-08-05T17:30:59.540Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags":[],"like_count":1,"views":1004,"category_id":15,"featured_link":null,"has_accepted_answer":false,"posters":[{"extras":"latest","description":"Original Poster, Most Recent Poster","user":{"id":2772,"username":"degville","name":"Graham Morrison","avatar_template":"/user_avatar/forum.snapcraft.io/degville/{size}/2021_2.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":9753,"username":"gvancuts","name":"Geoffroy","avatar_template":"/letter_avatar/gvancuts/{size}/5_6d6f4cde2641c35611d5cac2fb97c77e.png"}}]},{"id":30851,"title":"Snap How-to guides","fancy_title":"Snap How-to guides","slug":"snap-how-to-guides","posts_count":1,"reply_count":0,"highest_post_number":1,"image_url":null,"created_at":"2022-07-12T10:45:54.942Z","last_posted_at":"2022-07-12T10:45:55.061Z","bumped":true,"bumped_at":"2022-07-12T10:45:55.061Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags":[],"like_count":0,"views":1546,"category_id":15,"featured_link":null,"has_accepted_answer":false,"posters":[{"extras":"latest single","description":"Original Poster, Most Recent Poster","user":{"id":2772,"username":"degville","name":"Graham Morrison","avatar_template":"/user_avatar/forum.snapcraft.io/degville/{size}/2021_2.png"}}]},{"id":30858,"title":"Snap Explanation guides","fancy_title":"Snap Explanation guides","slug":"snap-explanation-guides","posts_count":3,"reply_count":1,"highest_post_number":3,"image_url":null,"created_at":"2022-07-12T15:01:07.909Z","last_posted_at":"2023-05-15T14:55:39.980Z","bumped":true,"bumped_at":"2023-05-15T14:55:39.980Z","archetype":"regular","unseen":false,"pinned":false,"unpinned":null,"visible":true,"closed":false,"archived":false,"bookmarked":null,"liked":null,"tags":[],"like_count":0,"views":1373,"category_id":15,"featured_link":null,"has_accepted_answer":false,"posters":[{"extras":"latest","description":"Original Poster, Most Recent Poster","user":{"id":2772,"username":"degville","name":"Graham Morrison","avatar_template":"/user_avatar/forum.snapcraft.io/degville/{size}/2021_2.png"}},{"extras":null,"description":"Frequent Poster","user":{"id":11710,"username":"rpjday","name":"Robert P. J. Day","avatar_template":"/user_avatar/forum.snapcraft.io/rpjday/{size}/8457_2.png"}}]}],"tags":["how-to"],"id":34179,"title":"Set up classic confinement for a Python project","fancy_title":"Set up classic confinement for a Python project","posts_count":1,"created_at":"2023-03-03T16:07:41.416Z","views":750,"reply_count":0,"like_count":1,"last_posted_at":"2023-03-03T16:07:41.560Z","visible":true,"closed":false,"archived":false,"has_summary":false,"archetype":"regular","slug":"set-up-classic-confinement-for-a-python-project","category_id":15,"word_count":564,"deleted_at":null,"user_id":14015,"featured_link":null,"pinned_globally":false,"pinned_at":null,"pinned_until":null,"image_url":null,"slow_mode_seconds":0,"draft":null,"draft_key":"topic_34179","draft_sequence":null,"unpinned":null,"pinned":false,"current_post_number":1,"highest_post_number":1,"deleted_by":null,"actions_summary":[{"id":4,"count":0,"hidden":false,"can_act":false},{"id":8,"count":0,"hidden":false,"can_act":false},{"id":7,"count":0,"hidden":false,"can_act":false}],"chunk_size":20,"bookmarked":false,"topic_timer":null,"message_bus_last_id":2,"participant_count":1,"show_read_indicator":false,"thumbnails":null,"details":{"notification_level":1,"participants":[{"id":14015,"username":"dboddie","name":"David Boddie","avatar_template":"/user_avatar/forum.snapcraft.io/dboddie/{size}/9564_2.png","post_count":1,"primary_group_name":null,"primary_group_flair_url":null,"primary_group_flair_color":null,"primary_group_flair_bg_color":null}],"created_by":{"id":14015,"username":"dboddie","name":"David Boddie","avatar_template":"/user_avatar/forum.snapcraft.io/dboddie/{size}/9564_2.png"},"last_poster":{"id":14015,"username":"dboddie","name":"David Boddie","avatar_template":"/user_avatar/forum.snapcraft.io/dboddie/{size}/9564_2.png"},"links":[{"url":"https://snapcraft.io/blog/the-new-classic-confinement-in-snaps-even-the-classics-need-a-change","title":"The new classic confinement in snaps – Even the classics need a change | Snapcraft","internal":false,"attachment":false,"reflection":false,"clicks":1,"user_id":14015,"domain":"snapcraft.io","root_domain":"snapcraft.io"}]}}